{% extends "tournaments/base.html" %}
{% block title %}Tournament Signup{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-xl font-semibold text-gray-900">Tournament Signup</h1>
            <p class="mt-2 text-sm text-gray-700">Sign up for an upcoming tournament.</p>
        </div>
    </div>
    <div class="mt-8 flex flex-col">
        <form method="get" class="max-w-md mx-auto mb-8">
            <label for="tournament_id" class="block text-sm font-medium text-gray-700 mb-2">Select a Tournament</label>
            <select name="tournament_id" id="tournament_id" class="w-full rounded-md border-gray-300 shadow-sm focus:border-[color:var(--color-primary-500)] focus:ring-[color:var(--color-primary-500)] sm:text-sm" onchange="this.form.submit()">
                <option value="">-- Choose a tournament --</option>
                {% for tournament in tournaments %}
                    <option value="{{ tournament.id }}" {% if selected_tournament and tournament.id == selected_tournament.id %}selected{% endif %}>{{ tournament.name }} ({{ tournament.date.strftime('%Y-%m-%d') }})</option>
                {% endfor %}
            </select>
        </form>
    </div>

    {% if selected_tournament %}
    <div class="mt-10">
        <div class="max-w-xl mx-auto">
            <h3 class="text-2xl font-bold text-center text-gray-900">Signup for {{ selected_tournament.name }}</h3>
            <form class="mt-8 space-y-6" method="POST">
                <input type="hidden" name="tournament_id" value="{{ selected_tournament.id }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="rounded-md shadow-sm bg-white p-6 space-y-5">
                    {% for field in fields %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{{ field.label }} {% if field.required %}*{% endif %}</label>
                        <div class="mt-1">
                        {% if field.type == 'text' %}
                            <input type="text" name="field_{{ field.id }}" {% if field.required %}required{% endif %} class="w-full rounded-md border-gray-300 shadow-sm focus:border-[color:var(--color-primary-500)] focus:ring-[color:var(--color-primary-500)] sm:text-sm">
                        {% elif field.type == 'radio' %}
                            <fieldset class="mt-2">
                                <legend class="sr-only">{{ field.label }}</legend>
                                <div class="space-y-2">
                                {% for opt in field.options.split(',') %}
                                    <div class="flex items-center">
                                        <input id="field_{{ field.id }}_{{ loop.index }}" name="field_{{ field.id }}" type="radio" value="{{ opt.strip() }}" class="h-4 w-4 border-gray-300 text-[color:var(--color-primary-600)] focus:ring-[color:var(--color-primary-500)]">
                                        <label for="field_{{ field.id }}_{{ loop.index }}" class="ml-3 block text-sm font-medium text-gray-700">{{ opt.strip() }}</label>
                                    </div>
                                {% endfor %}
                                </div>
                            </fieldset>
                        {% elif field.type == 'dropdown' %}
                             <select name="field_{{ field.id }}" {% if field.required %}required{% endif %} class="w-full rounded-md border-gray-300 shadow-sm focus:border-[color:var(--color-primary-500)] focus:ring-[color:var(--color-primary-500)] sm:text-sm">
                                {% for opt in field.options.split(',') %}<option value="{{ opt.strip() }}">{{ opt.strip() }}</option>{% endfor %}
                            </select>
                        {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    {% if user_events and user_events|length > 0 %}
                    <div class="border-t border-gray-200 pt-5">
                        <label class="text-base font-medium text-gray-900">Select your event(s)</label>
                        <fieldset class="mt-4">
                            <div class="space-y-4">
                            {% for event in user_events %}
                                <div class="flex items-start">
                                    <div class="flex h-5 items-center">
                                        <input id="event_{{ event.id }}" name="user_event" type="checkbox" value="{{ event.id }}" class="h-4 w-4 rounded border-gray-300 text-[color:var(--color-primary-600)] focus:ring-[color:var(--color-primary-500)]" onchange="togglePartnerSelection({{ event.id }}, {{ event.is_partner_event|default(false)|tojson }})">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="event_{{ event.id }}" class="font-medium text-gray-700">{{ event.event_name }} {{ event.event_emoji }}</label>
                                        {% if event.is_partner_event %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 ml-2">Partner Event</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if event.is_partner_event %}
                                <div id="partner_selection_{{ event.id }}" class="ml-7 mt-2 hidden">
                                    <label for="partner_{{ event.id }}" class="block text-sm font-medium text-gray-700">Select Partner</label>
                                    <div class="mt-1 relative">
                                        <input type="text" id="partner_search_{{ event.id }}" name="partner_search_{{ event.id }}" placeholder="Search for a partner..." class="w-full rounded-md border-gray-300 shadow-sm focus:border-[color:var(--color-primary-500)] focus:ring-[color:var(--color-primary-500)] sm:text-sm" onkeyup="searchPartners({{ event.id }})">
                                        <input type="hidden" id="partner_{{ event.id }}" name="partner_{{ event.id }}" value="">
                                        <div id="partner_results_{{ event.id }}" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden">
                                            <!-- Search results will be populated here -->
                                        </div>
                                    </div>
                                    <div id="selected_partner_{{ event.id }}" class="mt-2 hidden">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Selected: <span id="partner_name_{{ event.id }}"></span>
                                            <button type="button" class="ml-1 inline-flex flex-shrink-0 h-4 w-4 text-green-400 hover:text-green-500" onclick="clearPartner({{ event.id }})">
                                                <span class="sr-only">Remove</span>
                                                <svg class="h-2 w-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                                    <path stroke-linecap="round" d="m1 1 6 6m0-6-6 6" />
                                                </svg>
                                            </button>
                                        </span>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                            </div>
                        </fieldset>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-[color:var(--color-primary-600)] hover:bg-[color:var(--color-primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[color:var(--color-primary-500)]">
                        Submit Signup
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
function togglePartnerSelection(eventId, isPartnerEvent) {
    const checkbox = document.getElementById(`event_${eventId}`);
    const partnerDiv = document.getElementById(`partner_selection_${eventId}`);
    
    if (isPartnerEvent && partnerDiv) {
        if (checkbox.checked) {
            partnerDiv.classList.remove('hidden');
        } else {
            partnerDiv.classList.add('hidden');
            clearPartner(eventId);
        }
    }
}

function searchPartners(eventId) {
    const searchInput = document.getElementById(`partner_search_${eventId}`);
    const resultsDiv = document.getElementById(`partner_results_${eventId}`);
    const query = searchInput.value.trim();
    
    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }
    
    // Make AJAX request to search for partners
    fetch(`/tournaments/search_partners?q=${encodeURIComponent(query)}&event_id=${eventId}`)
        .then(response => response.json())
        .then(data => {
            resultsDiv.innerHTML = '';
            if (data.users && data.users.length > 0) {
                data.users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-50';
                    div.onclick = () => selectPartner(eventId, user.id, `${user.first_name} ${user.last_name}`);
                    div.innerHTML = `
                        <span class="block truncate">${user.first_name} ${user.last_name}</span>
                    `;
                    resultsDiv.appendChild(div);
                });
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.innerHTML = '<div class="py-2 pl-3 pr-9 text-gray-500">No users found</div>';
                resultsDiv.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error searching partners:', error);
            resultsDiv.classList.add('hidden');
        });
}

function selectPartner(eventId, partnerId, partnerName) {
    document.getElementById(`partner_${eventId}`).value = partnerId;
    document.getElementById(`partner_search_${eventId}`).value = '';
    document.getElementById(`partner_results_${eventId}`).classList.add('hidden');
    document.getElementById(`partner_name_${eventId}`).textContent = partnerName;
    document.getElementById(`selected_partner_${eventId}`).classList.remove('hidden');
}

function clearPartner(eventId) {
    document.getElementById(`partner_${eventId}`).value = '';
    document.getElementById(`partner_search_${eventId}`).value = '';
    document.getElementById(`partner_results_${eventId}`).classList.add('hidden');
    document.getElementById(`selected_partner_${eventId}`).classList.add('hidden');
}

// Hide partner search results when clicking outside
document.addEventListener('click', function(e) {
    const partnerSearchInputs = document.querySelectorAll('[id^="partner_search_"]');
    partnerSearchInputs.forEach(input => {
        if (!input.contains(e.target)) {
            const eventId = input.id.split('_')[2];
            const resultsDiv = document.getElementById(`partner_results_${eventId}`);
            if (resultsDiv) {
                resultsDiv.classList.add('hidden');
            }
        }
    });
});
</script>
{% endblock %}
